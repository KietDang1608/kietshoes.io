<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../assets/css/login.css">
    <link rel="stylesheet" href="../Components/assets/css/global.css">
    <link rel="icon" href="../assets/images/Logo.png">
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

    <title>ADMIN</title>
    <script src="../assets/js/validate.js"></script>
    <script src="https://smtpjs.com/v3/smtp.js"></script>

</head>

<body>
    <div class="login">
        <div class="model_loading">
            <div class="lds-ripple">
                <div></div>
                <div></div>
            </div>
        </div>
        <div class="toast__message-custom"></div>
        <div class="login_form">
            <div class="login_logo">
                <img src="../assets/images/logo.png" alt="logo">
                <p> ADMIN</p>
            </div>
            <div id="login_form_load" class="login_form-input">

            </div>
        </div>
        <div class="login_contact">
            <div class="login_contact_modal">
                <img src="../assets/images/Art-work.png" alt="Art-work">
            </div>

            <div class="login_coppyright">
                <p>Copyright @ web1.vn Term of use • Privacy policy • Help center</p>

            </div>
        </div>
    </div>

    <script src="../Components/assets/js/common.js"></script>

    <script type="text/javascript" defer>

        document.addEventListener('DOMContentLoaded', () => {
            setInterval(async () => {
                try {
                    const online = await fetch("https://img.shields.io/github/workflow/status/ssda/asd/ss");

                    return online.status >= 200 && online.status < 300

                } catch (err) {
                    window.location.href = '../../Client/Network/network_error.html'
                    return false;
                }

            }, 3000)
            const accounts = JSON.parse(localStorage.getItem('accountAdmin'));
            const token = localStorage.getItem("access_token");

            if (token !== null) {
                const tokenDecode = JSON.parse(atob(token));
                let isCheck = false;
                accounts.filter((account) => {
                    if (tokenDecode.email === account.email && tokenDecode.password === atob(account.password && account.role === 'admin')) {
                        isCheck = true;
                    }
                });
                if (!isCheck) {
                    window.location.href = '../Components/layout.html';
                }
            }

        });
        loadFileHtml('login_form_load', './login');

        function onValidateLogin(e) {
            return Validator({
                form: '#form_login',
                formGroupSelector: '.form_group',
                errorSelector: '.form-message',
                rules: [

                    Validator.isRequired('#login_email', "Email is required."),
                    Validator.isEmail('#login_email', "Email is invalid."),
                    Validator.isRequired('#login_password', "Password is required."),
                    Validator.minLength('#login_password', 6, "Password must be at least 6 characters."),
                ],
            })


        }
        function onValidateForgot() {
            Validator({
                form: '#form_forgot',
                formGroupSelector: '.form_group',
                errorSelector: '.form-message',
                rules: [

                    Validator.isRequired('#forgot_email', "Email is required."),
                    Validator.isEmail('#forgot_email', "Email is invalid."),

                ],
            })
        }
        function submitForgot(e) {
            e.onCLick = (event) => {
                event.preventDefault()
            }
            const email = document.getElementById("forgot_email").value;
            if (email !== "") {
                loadingButton(e, true);
                const accounts = JSON.parse(localStorage.getItem('accountAdmin'));
                let isCheck = false;
                const subject = 'Forgot Password';

                accounts.filter((account) => {
                    if (email === account.email && account.role === 'admin') {
                        isCheck = true;
                    }
                });
                if (isCheck) {
                    const password_forgot = Math.floor(Math.random() * 6000000) + 1
                    Email.send({
                        Host: "smtp.elasticemail.com",
                        Username: "miniappmarketing@gmail.com",
                        Password: "87959F06A266B8C7A359CF8F3926A5A8DFDE",
                        To: email.trim(),
                        From: "miniappmarketing@gmail.com",
                        Subject: subject,
                        Body: "password :" + password_forgot,
                    }).then(

                        message => {
                            let result = [];
                            loadingButton(e, false);
                            if (message === 'OK') {
                                accounts.filter((account) => {
                                    if (email === account.email && account.role === 'admin') {
                                        result = [
                                            {
                                                ...account,
                                                password: btoa(password_forgot),
                                                updated_at: new Date().toLocaleDateString('en-US'),
                                            }
                                        ];
                                    } else {
                                        result = [
                                            { ...account },
                                        ];
                                    }
                                });
                                localStorage.setItem('accountAdmin', JSON.stringify(result));
                                showMessage('Success', 'Sented mail successfully', 'success', 3000)
                            } else {
                                showMessage('Errors', 'Sent mail failed', 'error', 3000)
                            }
                        }
                    );
                } else {
                    loadingButton(e, false);
                }
            } else {
                showMessage('Error', 'Email is invalid', 'error', 3000)
            }


        }
        function submitLogin(e) {
            e.onCLick = (event) => {
                event.preventDefault();
            }
            const email = document.getElementById("login_email").value;
            const password = document.getElementById("login_password").value;
            if (
                email !== "" && password !== "" && password.length >= 6
            ) {
                loadingButton(e, true);
                const accounts = JSON.parse(localStorage.getItem('accountAdmin'));
                let isCheck = false;
                accounts.filter((account) => {
                    if (email === account.email && password === atob(account.password) && account.role === 'admin') {
                        isCheck = true;
                    }
                });

                if (isCheck) {
                    const token = {
                        email: email,
                        password: password
                    };
                    setTimeout(() => {
                        localStorage.setItem('access_token', btoa(JSON.stringify(token)));
                        showMessage('Success', 'Login successfully', 'success', 3000)
                        window.location.href = '../Components/layout.html';
                    }, 2500)
                } else {
                    setTimeout(() => {
                        loadingButton(e, false);
                        showMessage('Error', 'Wrong login information', 'error', 3000)
                    }, 2500)
                }

            } else {
                showMessage('Error', 'Email and password is invalid', 'error', 3000)
            }





        }

    </script>
</body>

</html>